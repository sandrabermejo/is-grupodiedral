\ProvidesPackage{isdiedral}[2013/03/01 v2.0 macros para el proyecto de Ingeniería del Software]
\typeout{ISDiedral}

% isdiedral.sty
% Grupo Diedral 2012-2013

% Paquetes requeridos
\NeedsTeXFormat{LaTeX2e}[2001/06/01]
\RequirePackage{color}
\RequirePackage{xkeyval}
\RequirePackage{tabularx}
\RequirePackage{ifthen}
\RequirePackage{environ}
\RequirePackage{multirow}
\RequirePackage{supertabular}
\RequirePackage{fancyhdr}
\RequirePackage{ifpdf}
\RequirePackage{tikz}
\RequirePackage{colortbl}
\RequirePackage{longtable}
\RequirePackage{tabu}

% Opciones soportadas
%\DeclareOption{trsubsec}{}

%%%%%%%%%%% DEFINICIÓN DE MODELO DE CASOS DE USO %%%%%%%%%%%%

%% Entrada de parámetros al estilo clave-valor (http://www.ctan.org/pkg/xkeyval) %%

% Se podría evitar almacenar los parámetros, imprimiendo la fila directamente.
\makeatletter
% Define las claves para xkeyval
\define@key{kcasodeuso}{nombre}{\def\casosdeusoNombre{#1}}
\define@key{kcasodeuso}{objetivo}{\def\casosdeusoObjetivo{#1}}
\define@key{kcasodeuso}{entradas}{\def\casosdeusoEntradas{#1}}
\define@key{kcasodeuso}{precondiciones}{\def\casosdeusoPrecondiciones{#1}}
\define@key{kcasodeuso}{salidas}{\def\casosdeusoSalidas{#1}}
\define@key{kcasodeuso}{postexito}{\def\casosdeusoPostexito{#1}}
\define@key{kcasodeuso}{posterror}{\def\casosdeusoPosterror{#1}}
\define@key{kcasodeuso}{actores}{\def\casosdeusoActores{#1}}
\makeatother

% Crea el contador de casos de uso
\newcounter{ncasouso}
\setcounter{ncasouso}{1}

%% Comando de casos de uso, requiere una lista de claves-valor con ciertos
% parámetros y dos tablas que representan secuencias.
\newcommand{\casodeuso}[3]{
	% Otorga valores iniciales a las variables (xkeyval también lo puede hacer).
	% Se utiliza def porque es altamente improbable que exista otro símbolo
	% con el mismo nombre (salvo el creado anteriormente)
	\def\casosdeusoNombre{\bfseries \color{red} <<Falta nombre>>}
	\def\casosdeusoObjetivo{\bfseries \color{red} <<Falta objetivo>>}
	\def\casosdeusoEntradas{}
	\def\casosdeusoPrecondiciones{}
	\def\casosdeusoSalidas{}
	\def\casosdeusoPostexito{}
	\def\casosdeusoPosterror{}
	\def\casosdeusoActores{\bfseries \color{red} <<Faltan actores>>}

	% Procesa el primer parámetro
	\setkeys{kcasodeuso}{#1}

	% Prepara la estructura del documento (mejorar/hacer bien)
	\refstepcounter{subsubsection}
	\addcontentsline{toc}{subsubsection}{\casosdeusoNombre}

	% Apaño para que los encabezados sean más explicativos (intentar algo más elegante)
	\renewcommand*{\rightmark}{\casosdeusoNombre}

	% Tabla principal
	\label{CU:\casosdeusoNombre} \begin{tabularx}{.9\linewidth}{| l | X |}
		\hline
		\multicolumn{1}{|c|}{\rmfamily \scshape Caso de uso \arabic{ncasouso}} & \multicolumn{1}{c|}{\bfseries \casosdeusoNombre} \\
		\hline
		Objetivo & \casosdeusoObjetivo \\
		\hline
		Entradas & \casosdeusoEntradas \\
		\hline
		Precondiciones & \casosdeusoPrecondiciones \\
		\hline
		Salidas & \casosdeusoSalidas \\
		\hline
		Postcondición si éxito & \casosdeusoPostexito \\
		\hline
		Postcondición si error & \casosdeusoPosterror \\
		\hline
		Actores & \casosdeusoActores \\
		\hline
	\end{tabularx}\\ \\

	% Tablas de secuencias
	\def\casosdeusoNombreTabla{Secuencia normal}
	#2\\

	\def\casosdeusoNombreTabla{Secuencias alternativas}
	#3\\

	\addtocounter{ncasouso}{1}
}

%% Entorno para las tablas de secuencias
\NewEnviron{tablasecuencias}{
	% Se considera que puede ser necesario introducir un entorno de tabla multipágina para esta función.
	\begin{tabularx}{.9\linewidth}{| >{\slshape \small \centering} p{.5cm} | X |} \hline
		% Imprime el encabezado de la tabla con el título almacenado
		\multicolumn{2}{|c|}{\ifthenelse{\isundefined{casosdeusoNombreTabla}}{\color{red} Tabla mal emplazada}{\casosdeusoNombreTabla}} \\ 			\hline
		% Escribe el cuerpo de la tabla
		\BODY\\\hline
	\end{tabularx} \\
}


%%%%%%%%%%% DEFINICIÓN DE COMANDOS PARA SRS %%%%%%%%%%%%

%% Alias para escribir soft(hard)ware en cursiva (de acuerdo a la RAE)
\newcommand{\software}{\textit{software} }
\newcommand{\hardware}{\textit{hardware} }

%% Alias para escribir marca registrada
\newcommand*{\marcaregistrada}{\raisebox{2mm}{\tiny\textregistered}}

%% Comandos de sección de nivel 4
% Definición general
\newcounter{subsubsubsection}[subsubsection]	% Crea el contador
\renewcommand{\thesubsubsubsection}{\thesubsubsection.\arabic{subsubsubsection}}	% Define el formato de numeración
\def\subsubsubsectionmark#1{}	% Por si acaso

\makeatletter
\newcommand\subsubsubsection{\@startsection
{subsubsubsection}{4}{\z@} {-3.25ex plus -1
ex minus -.2ex}{1.5ex plus .2ex}{\normalfont \itshape \bfseries}}	% Define el comando de sección
\newcommand{\l@subsubsubsection}{\@dottedtocline{4}{10em}{4.2em}}	% Establece como aparecerá en el índice
\providecommand*{\toclevel@subsubsubsection}{4}			% Fija su nivel en el índice (hyperref)
\makeatother

% Macro para función
\newcommand{\srsfuncion}[1]{\subsubsubsection{#1}}


%%%%%%%%%%% CONTROL DE CAMBIOS %%%%%%%%%%%%

% Ver implementación de la portada

\NewEnviron{tablacambios}{
	\global\expandafter\def\expandafter\tablacambioscontenido\expandafter{\BODY}
}


%%%%%%%%%% DEFINICIÓN DE MODELO DE FORMULARIO DE RIESGOS %%%%%%%%%%%%%

\makeatletter
% Define las claves para xkeyval
\define@key{kriesgos}{id}{\def\riesgosID{#1}}
\define@key{kriesgos}{identificador}{\def\riesgosIdentificador{#1}}
\define@key{kriesgos}{fecha}{\def\riesgosFecha{#1}}
\define@key{kriesgos}{descripcion}{\def\riesgosDescripcion{#1}}
\define@key{kriesgos}{influye}{\def\riesgosInfluye{#1}}
\define@key{kriesgos}{consecuencia}{\def\riesgosConsecuencia{#1}}
\define@key{kriesgos}{impacto}{\def\riesgosImpacto{#1}}
\define@key{kriesgos}{probabilidad}{\def\riesgosProbabilidad{#1}}
\define@key{kriesgos}{periodo}{\def\riesgosPeriodo{#1}}
\define@key{kriesgos}{estrategia}{\def\riesgosEstrategia{#1}}
\define@key{kriesgos}{contingencia}{\def\riesgosContingencia{#1}}
\define@key{kriesgos}{grupo}{\def\riesgosGrupo{#1}}
\makeatother

% Crea el contador de riesgos
\newcounter{nriesgos}
\setcounter{nriesgos}{1}

% Configura supertabular para notificar el salto de línea
\tabletail{\hline \multicolumn{3}{r}{\emph{Continúa en la página siguiente...}}\\}
\tablelasttail{}

%% Comando de hojas de riesgos, requiere una lista de claves-valor con ciertos
% parámetros.
\newcommand{\hojariesgo}[2]{
	% Otorga valores iniciales a las variables (xkeyval también lo puede hacer).
	% Se utiliza def porque es altamente improbable que exista otro símbolo	
	% con el mismo nombre (salvo el creado anteriormente)
	\def\riesgosID{\bfseries \color{red} <<Falta ID>>}
	\def\riesgosIdentificador{}
	\def\riesgosFecha{\bfseries {\color{red} <<Falta fecha>>}}
	\def\riesgosDescripcion{\bfseries {\color{red} <<Falta descripción>>}}
	\def\riesgosInfluye{\bfseries {\color{red} ?}}
	\def\riesgosConsecuencia{\bfseries {\color{red} ?}}
	\def\riesgosImpacto{\bfseries {\color{red} ?}}
	\def\riesgosProbabilidad{\bfseries {\color{red} ?}}
	\def\riesgosPeriodo{\bfseries {\color{red} ?}}
	\def\riesgosEstrategia{\bfseries {\color{red} <<Falta estrategia>>}}
	\def\riesgosContingencia{\bfseries {\color{red} <<Falta plan de contigencia>>}}
	\def\riesgosGrupo{}

	% Procesa el segundo parámetro
	\setkeys{kriesgos}{#2}

	\subsubsection{#1}

	% Tabla principal
	\label{Riesgos:\riesgosID} \begin{supertabular}{| p{.1\linewidth} | p{.5\linewidth} | p{.3\linewidth} |}
		\hline
		\multicolumn{3}{|c|}{\bfseries Formulario de descripción de riesgo} \\
		\hline
		\multicolumn{2}{|l|}{\textbf{Identificado por:} \riesgosIdentificador} & \textbf{Fecha:} \riesgosFecha \\
		\hline
		\multicolumn{2}{|l|}{} & \textbf{ID:} \riesgosID \\
		\hline
		\multicolumn{3}{|p{\linewidth}|}{\textbf{Descripción de riesgo (con contexto):} \riesgosDescripcion} \\
		\hline
		\riesgosInfluye & \scriptsize Influye en (\textbf{c}oste, calendario (\textbf{s}), \textbf{r}endimiento, calidad (\textbf{q})) & Impacto del riesgo: \riesgosImpacto\\
		\hline
		\riesgosConsecuencia & \scriptsize Consecuencia (\textbf{C}atastrófico, \textbf{c}rítico, \textbf{s}erio, \textbf{m}enor, \textbf{i}nsignificante) & \multirow{3}{*}{}\\
		\cline{1-2}
		\riesgosProbabilidad & \scriptsize Probabilidad (\textbf{f}recuente, \textbf{p}robable, \textbf{o}casional, \textbf{r}emota, \textbf{i}mprobable) & \\
		\cline{1-2}
		\riesgosPeriodo & \scriptsize Periodo (\textbf{c}orto plazo, \textbf{l}argo plazo) &\\
		\hline
		\multicolumn{3}{|p{\linewidth}|}{\textbf{Estrategia de mitigación:} \riesgosEstrategia} \\
		\hline
		\multicolumn{3}{|p{\linewidth}|}{\textbf{Detonantes y acción de contigencia:} \riesgosContingencia} \\
		\hline
		\multicolumn{3}{|l|}{\textbf{Grupo:} \riesgosGrupo} \\
		\hline
	\end{supertabular}\\

	\addtocounter{nriesgos}{1}
}

% Tabla sumario de riesgos
\NewEnviron{tablariesgos}{
	% Primera cabecera de tabla
	\tablefirsthead{\hline
		\multicolumn{7}{|c|}{\bfseries Resumen de riesgos} \\ \hline
		\itshape ID & \itshape Denominación & \itshape Duración & \itshape Ámbito & \itshape Probab. & \itshape Consec. & \itshape Impac. \\ \hline
	}

	% Cabecera de tabla para páginas subsiguientes
	\tablehead{\hline \itshape ID & \itshape Denominación & \itshape Duración & \itshape Ámbito & \itshape Probab. & \itshape Consec. & \itshape Impac. \\}

	\begin{center}
	\begin{supertabular}{| l | p{.35\linewidth} | c | c | c | c | c |} \hline
		% Escribe el cuerpo de la tabla
		\BODY\\\hline
	\end{supertabular}
	\end{center}

	% Reinicia las configuraciones de "supertabular"
	\tablefirsthead{}
	\tablehead{}
}

% Tabla de descripción de material
\newcommand{\recurso}[6]{
	\begin{tabularx}{.9\linewidth}{>{\bfseries}r X}
		\hline \\
		#1		& #2 \\
		Descripción:	& #3 \\
		\ifthenelse{\equal{#4}{}}{}%
		{Procedencia: 	& #4 \\}
		Disponibilidad: & #5
		\ifthenelse{\equal{#6}{}}{}%
		{\\ Uso: 	& #6 \\}
    \end{tabularx}
}


%%%%%%%%%% OTRAS DEFINICIONES PLAN DE PROYECTO %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Requiere un parámetro que es el nombre de función
\NewEnviron{tablapf}[2]{
	\begin{center}
	\begin{tabu} to .9\linewidth {| >{\itshape}X[1, l] | X[1, l] | X[1, l] | X[1, l] | X[1, l] | X[1, l] | X[1, l] | X[1, l] |} \hline
		% Encabezado general
		\multicolumn{8}{|c|}{\bfseries #1} \\ \hline

		\rowfont{\itshape} & \multicolumn{2}{c|}{Baja} & \multicolumn{2}{c|}{Media} & \multicolumn{2}{c|}{Alta} & \multicolumn{1}{c|}{PF}\\ \hline
		
		% Encabezado particular
		& Número & Peso & Número & Peso & Número & Peso & \\ \hline
		
		% Aquí va el contenido
		\BODY\\\hline
		\multicolumn{7}{|r|}{TOTAL:} & #2 \\ \hline
	\end{tabu}
	\end{center}
}

%%%%%%%%%% DEFINICIÓN DE CONVENCIONES SOBRE ENCABEZADOS Y PIE DE PÁGINA %%%%%%%%%%%%%
% Requiere como parámetro el nombre del documento y el número total de PFs
\newcommand*{\encabezadodiedral}[1]{
	\definecolor{hdrgray}{gray}{0.6}
	\fancyhead[REH, LOH]{\color{hdrgray}#1 > \nouppercase{\rightmark}}
	\fancyhead[LEH, ROH]{\thepage}
	\fancyfoot[C]{\color{hdrgray} \scriptsize \textit{Airline Common Environment} - Grupo Diedral}
	\setlength{\headheight}{15pt}
	\renewcommand{\headrulewidth}{.1pt}
}

\newcommand{\iniciarnumeraciondiedral}{
	\setcounter{page}{1}
	\renewcommand*{\thepage}{\arabic{page}}
}

%%%%%%%%% PÁGINA DE TÍTULO CON FORMATO COMÚN PARA EL PROYECTO ACE %%%%%%%%%%%%%%

% Definición del formato de cita célebre
\newcommand*{\citacelebre}[3][6cm]{\begin{flushright} \parbox{#1}{\raggedleft \itshape <<#2>> \flushright \normalfont \small #3}\end{flushright}}

% Definifinición del comando para asignar la cita
\newcommand{\fijacitainicial}[2]{\newcommand*{\citatrasportada}{#1}\newcommand*{\citatrasportadaautor}{#2}}

\newcommand{\portadaace}[1]{
\ifpdf
\begin{titlepage}
		% Título del documento
		\begin{center}
		\vspace*{2cm}
			{\fontsize{60}{72} \selectfont \bfseries \color{green!15!black!85} #1}

		\begin{center}
			\itshape v2.0 - \today % Hacer pasar como parámetro
		\end{center}

		\vfill

		\normalsize



		% Autores y nombre del proyecto (con PGF/TikZ)
		\begin{tikzpicture}
			\draw (1, 1.5) node[above]{\color{gray} \Huge \itshape Airline Common Environment};
			\draw (1, 1.5) node[yscale=-1, above, opacity=0.1]{\color{gray} \Huge \itshape Airline Common Environment};

			\draw (-4, -0.2) node[below]{\includegraphics[scale=.06]{../common/logodiedral.pdf}};
			\draw (-4.1, -2.5) node[below]{\bfseries Grupo Diedral};

			\draw (5, -.6) node[below]{
				\begin{tabular}{r}
					Cristina Alonso Fernández\\
					Natalia Angulo Herrera\\
					Sandra Bermejo Cañadas\\
					Juan Andreś Claramunt Pérez\\
					Rubén Rafael Rubio Cuéllar
				\end{tabular}
			};

		\end{tikzpicture}
		\end{center}
	\end{titlepage}
\else
	\maketitle
\fi

	% Introduce la contrapágina de la portada
	\thispagestyle{empty}
	\ifthenelse{\isundefined{\citatrasportada}}{\phantom{}}{
		\citacelebre{\citatrasportada}{\citatrasportadaautor}
	}
	\vfill

	% Si el documento ha especificado tabla de cambios la añade
	\ifthenelse{\isundefined{\tablacambioscontenido}}{}{
		\begin{center}
		\begin{tabularx}{.85\linewidth}{| c | c | l | X |} \hline
			\rowcolor{black!5} \multicolumn{4}{|c|}{\bfseries Control de cambios} \\ \hline
			\rowcolor{black!2} \itshape Versión & \itshape Fecha & \itshape Autores & \itshape Descripción\\ \hline
			% Escribe el cuerpo de la tabla
			\tablacambioscontenido\\\hline
		\end{tabularx}
		\end{center}

		\vspace*{1cm}
	}

	Grupo Diedral, 2013\\

	Impreso en Madrid
	\newpage
}

% Entorno prólogo
\newenvironment{prologo}{\newpage \section*{\addcontentsline{toc}{section}{Prólogo} Prólogo} \renewcommand*{\rightmark}{Prólogo}}{\newpage}

% Fin del paquete "isdiedral.sty"
